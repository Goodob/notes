<!DOCTYPE html>
<html>
<head>
<title>struts</title>
<!-- 2016-10-18 周二 07:35 -->
<meta  charset="utf-8">
<meta  name="generator" content="Org-mode">
<meta  name="author" content="imfine">
<link rel="stylesheet" href="ss.css">
</head>
<body>
<div id="content">
<h1 class="title">struts</h1>
<nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">Preclue</a></li>
<li><a href="#sec-2">框架</a></li>
<li><a href="#sec-3">简介</a></li>
<li><a href="#sec-4">示例（注册登录）</a>
<ul>
<li><a href="#sec-4-1">业务分析</a></li>
<li><a href="#sec-4-2">实现步骤：</a></li>
</ul>
</li>
<li><a href="#sec-5">Package</a></li>
<li><a href="#sec-6">Action</a></li>
<li><a href="#sec-7">Result</a>
<ul>
<li><a href="#sec-7-1">dispatcher/redirect</a></li>
<li><a href="#sec-7-2">chain/redirectAction</a></li>
<li><a href="#sec-7-3">stream</a></li>
</ul>
</li>
<li><a href="#sec-8">流程</a></li>
<li><a href="#sec-9">拦截器</a>
<ul>
<li><a href="#sec-9-1">原理</a></li>
<li><a href="#sec-9-2">定义</a></li>
<li><a href="#sec-9-3">示例</a></li>
</ul>
</li>
<li><a href="#sec-10">自动封装(Autowired)</a></li>
<li><a href="#sec-11">值栈</a>
<ul>
<li><a href="#sec-11-1">在 jsp 中获取值栈的值</a></li>
<li><a href="#sec-11-2">在 action 类中，获取 session 等对象的方法</a></li>
</ul>
</li>
<li><a href="#sec-12">标签库</a></li>
<li><a href="#sec-13">验证</a></li>
<li><a href="#sec-14">类型转换</a></li>
<li><a href="#sec-15">国际化</a></li>
<li><a href="#sec-16">文件的上传下载</a></li>
<li><a href="#sec-17">防止重复提交</a></li>
<li><a href="#sec-18">ajax</a></li>
</ul>
</div>
</nav>


<section id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Preclue</h2>
<div class="outline-text-2" id="text-1">
<p>
Tomcat 编译 jsp 到 java 文件的保存目录：
</p>
<pre class="example">
E:\workspace\.metadata\.plugins\org.eclipse.wst.server.core\tmp0\work\Catalina\localhost\hello\org\apache\jsp\WEB_002dINF\login
</pre>
</div>
</section>

<section id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">框架</h2>
<div class="outline-text-2" id="text-2">
<p>
框架是一个半成品。它提供了一些接口、类、方法，我们可以直接调用。
</p>

<p>
所以使用框架，相当于在别人开发了一半的项目上继续开发。
</p>

<p>
因此，框架有以下优势：
</p>
<ol class="org-ol">
<li>能提高我们的开发效率。
</li>
<li>能大幅度减少我们的代码量。
</li>
<li>能提高代码的健壮性。比如，jquery的跨浏览器问题。
</li>
</ol>
</div>
</section>


<section id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">简介</h2>
<div class="outline-text-2" id="text-3">
<p>
Struts2 是一个流行的 MVC 框架。
</p>

<p>
官方网站：<a href="https://struts.apache.org/">https://struts.apache.org/</a>
</p>


<p>
导入 struts-blank 项目有两种方式： maven 方式和一般方式。下面介绍一般的方式：
</p>
<ol class="org-ol">
<li>在 eclipse 中，选择新建一个 dynamic web project，例如名字为 ls02.
</li>
<li>将 src/apps/blank/src/main/java 下的文件复制到 workspace/ls02/src 文件夹下。
</li>
<li>将 src/apps/blank/src/main/resources 下的文件复制到 workspace/ls02/src 文件夹下。
</li>
<li>将 src/apps/blank/src/main/webapp 下的文件复制到 workspace/ls02/WebContent 文件夹下。
</li>
<li>将相关的 jar 包放到 workspace/ls02/WebContent/WEB-INF/lib 文件夹下。
</li>
</ol>

<p>
需要的jar包有以下：
</p>
<ul class="org-ul">
<li>asm-3.3.jar
</li>
<li>asm-commons-3.3.jar
</li>
<li>asm-tree-3.3.jar
</li>
<li>commons-fileupload-1.3.2.jar
</li>
<li>commons-io-2.2.jar
</li>
<li>commons-lang3-3.2.jar
</li>
<li>hamcrest-core-1.3.jar
</li>
<li>javassist-3.11.0.GA.jar
</li>
<li>javax.servlet-api-3.1.0.jar
</li>
<li>javax.servlet.jsp-api-2.3.1.jar
</li>
<li>jstl-1.2.jar
</li>
<li>junit-4.12.jar
</li>
<li>log4j-1.2.17.jar
</li>
<li>ognl-3.0.19.jar
</li>
<li>ojdbc7.jar
</li>
<li>struts2-core-2.3.30.jar
</li>
<li>struts2-json-plugin-2.3.30.jar
</li>
<li>xwork-core-2.3.30.jar
</li>
</ul>
</div>
</section>

<section id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">示例（注册登录）</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1">业务分析</h3>
<div class="outline-text-3" id="text-4-1">
<p>
我们需要以下四个请求：、
</p>
<ol class="org-ol">
<li>第一个请求：<br >
   显示登录的页面。  login.jsp
</li>

<li>第二个请求：<br >
   点击登录之后，要完成登录的操作。
welcome.jsp
fail.jsp
</li>

<li>第三个请求：<br >
   显示注册的页面。
regist.jsp
</li>

<li>第四个请求：<br >
   点击“注册”按钮之后，完成注册的操作。
login.jsp
regerror.jsp
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2">实现步骤：</h3>
<div class="outline-text-3" id="text-4-2">
<ol class="org-ol">
<li><b>建立动态web项目。</b>

<p>
打开 eclipse，选择 File -&gt; New -&gt; Dynamic Web Project(快捷键为Ctrl-N)。
</p>

<p>
注意，工程名字尽量简洁，尽量用小写字母和_的组合。
</p>

<p>
注意，在创建的工程的时候，将创建 web.xml 的选项勾上。
因为在 servlet3 版本中，可以不需要 web.xml 的情况下运行 web 工程，但是我们要使用 struts2，必须要在 web.xml 中进行若干的配置。
</p>
</li>

<li><b>将相关的 jar 包，复制到 工程目录/WebContent/WEB-INF/lib 文件夹下面。</b>

<p>
注意，一定不要缺少某些关键包，否则可能会报错。
</p>

<p>
注意，如果出现一些莫名其妙的问题，包括像报 ClassNotFound 的异常，这时候，首先要检查是否有 jar 包的缺失。
</p>
</li>

<li><b>配置 web.xml，将所有的请求交给 struts 进行处理。</b>

<p>
即在 web.xml 中添加以下内容：
</p>
<div class="org-src-container">

<pre class="src src-xml">&lt;<span style="color: #000088; background-color: #DEDEDE;">filter</span>&gt;
    &lt;<span style="color: #000088; background-color: #DEDEDE;">filter-name</span>&gt;struts&lt;/<span style="color: #000088; background-color: #DEDEDE;">filter-name</span>&gt;
    &lt;<span style="color: #000088; background-color: #DEDEDE;">filter-class</span>&gt;org.apache.struts2.dispatcher.ng.filter.StrutsPrepareAndExecuteFilter&lt;/<span style="color: #000088; background-color: #DEDEDE;">filter-class</span>&gt;
&lt;/<span style="color: #000088; background-color: #DEDEDE;">filter</span>&gt;
&lt;<span style="color: #000088; background-color: #DEDEDE;">filter-mapping</span>&gt;
    &lt;<span style="color: #000088; background-color: #DEDEDE;">filter-name</span>&gt;struts&lt;/<span style="color: #000088; background-color: #DEDEDE;">filter-name</span>&gt;
    &lt;<span style="color: #000088; background-color: #DEDEDE;">url-pattern</span>&gt;/*&lt;/<span style="color: #000088; background-color: #DEDEDE;">url-pattern</span>&gt;
&lt;/<span style="color: #000088; background-color: #DEDEDE;">filter-mapping</span>&gt;
</pre>
</div>

<p>
注意： filter-name 是可以随意定义的，不过上下两个节点要填写一致，不要搞错。
</p>

<p>
注意： 要确保 filter-class 的值写正确，这是一个确切存在的过滤器类。可以通过查看 struts2-core.jar 的源码去确定。
</p>

<p>
注意： 在 elipse 左边的 Web App Libraries 下面，找到 struts2-core.jar，打开节点，直到 StrutsPrepareAndExecuteFilter，然后右键点击，选择 Copy Qualified Name，这样就把这个过滤器的完整路径复制下来了。然后就可以在 web.xml 中进行粘贴了。
</p>

<p>
注意： 如果创建完工程之后，发现没有 web.xml，那么你需要自己创建或者从其他地方拷贝一个 web.xml 过来。但是注意，一定不要讲文件放错位置（WebContent/WEB-INF/web.xml）。而且，要注意 xml 中头部务必要写正确， xml 的格式也不能出现问题。
</p>

<p>
注意： 以前的老旧版本中，使用的是过滤器 org.apache.struts2.dispatcher.FilterDispatcher。但现在已经被抛弃，不要使用，而是用 StrutsPrepareAndExecuteFilte代替。
</p>
</li>

<li><b>创建文件 struts.xml，配置所有模块和请求，即配置相应的 package 和 action。</b>

<p>
这是 struts 的配置中心，所有的 struts 属性配置和请求映射，都在这个文件夹中进行action设置。
</p>

<p>
需要将这个文件放在 classpath 的根目录下面。我们可以理解，我们需要在 工程目录/src 文件夹下面创建这个文件。
</p>

<p>
如果我们创建的工程能够运行起来不报错，但是我们的 action 请求返回404错误的话，首先需要检查我们的请求有没有写错，如果没有写错，那么，就要检查是不是我们的 struts.xml 放错了位置或写错了名字。
</p>

<p>
如果我们的工程能够运行，但是在请求的时候，返回一些比如 result 没有正确映射等错误，那么，我们就需要检查是不是在 struts.xml 中配置错了东西。
</p>

<p>
struts.xml，最好我们备份一份，在创建的时候，直接拷贝。因为，这个文件的格式，尤其是头部：
</p>
<div class="org-src-container">

<pre class="src src-xml">&lt;?<span style="color: #0000FF;">xml</span> <span style="color: #BA36A5;">version</span>=<span style="color: #008000;">"</span><span style="color: #008000;">1.0</span><span style="color: #008000;">"</span> <span style="color: #BA36A5;">encoding</span>=<span style="color: #008000;">"</span><span style="color: #008000;">UTF-8</span><span style="color: #008000;">"</span> ?&gt;
&lt;!<span style="color: #0000FF;">DOCTYPE</span> struts <span style="color: #0000FF;">PUBLIC</span>
 <span style="color: #036A07;">"</span><span style="color: #036A07;">-//Apache Software Foundation//DTD Struts Configuration 2.3//EN</span><span style="color: #036A07;">"</span>
 <span style="color: #036A07;">"</span><span style="color: #036A07;">http://struts.apache.org/dtds/struts-2.3.dtd</span><span style="color: #036A07;">"</span>&gt;

&lt;<span style="color: #000088; background-color: #DEDEDE;">struts</span>&gt;
   &lt;<span style="color: #000088; background-color: #DEDEDE;">package</span>&gt;&lt;/<span style="color: #000088; background-color: #DEDEDE;">package</span>&gt;
&lt;/<span style="color: #000088; background-color: #DEDEDE;">struts</span>&gt;
</pre>
</div>
<p>
头部的 dtd 文件可以在 struts2-core.jar 的根目录之下找到。里面可以拷贝到 DOCTYPE 的定义。
</p>

<p>
注意， <b>一个请求对应一个 action</b> 。这个概念务必要理解。另外，一个业务模块定义在一个 package 中，这个也要掌握。
</p>

<p>
我们可以使用通配符来简化 action 配置。但务必不要滥用通配符，尤其刚开始的时候不建议过多使用通配符。
</p>
</li>

<li><b>实现相应的 jsp</b>

<p>
一些比较敏感的，尤其是涉及权限的东西，我们最好放在 WEB-INF 目录下面，因为按照 j2ee 的规范， WEB-INF 目录下的内容，不能够由外部直接访问，所以能够最大限度保证安全。
</p>

<p>
那我们也要养成一种习惯，把主要的业务操作方面的 jsp 放在 WEB-INF 下面，一些其他的通用的不重要的资源可以放在 WEB-INF 外面。
</p>
</li>

<li><b>实现相应的 action</b>

<p>
Action 中的每个执行业务的方法，只有一个要求，不携带参数并返回 String 类型。而一个 action 就是一个普通的 java 对象。不过为了方便，绝大多数时候我们要为我们自己定义的 Action 继承 ActionSupport 类。
</p>

<p>
需要注意，必须要养成良好的编程习惯。习惯成自然，不要让不好的习惯带给我们一些莫名其妙的损失。
</p>

<p>
下面是一些基本的规范：
</p>
<ul class="org-ul">
<li>我们写类跟接口之前，必须要定义一个相对完整的包。尤其忌讳把所有的东西都放在 classpath 的跟路径之下。
</li>
<li>包的名字要有相应的意义，不同种类的类或接口要放在不同的包中，不要混乱地放在一起。
</li>
<li>包的名字，务必要用小写字母。
</li>
<li>类或接口的名字，务必务必要用大写字母开头，而且要写成驼峰格式。
</li>
<li>里面的方法也要写成驼峰形式。
</li>
<li>格式要对齐，文件中要么都是用 tab，要么都使用空格，不建议混用，否则，可能在别人的电脑上，会出现代码对不齐的现象。
</li>
<li>等号等操作符的前面和后面，要带有空格，便于阅读。
</li>
</ul>
</li>
</ol>
</div>
</div>
</section>

<section id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">Package</h2>
<div class="outline-text-2" id="text-5">
<p>
在 struts.xml 中首先需要定义 package，package 我们可以理解为一个业务模块。
</p>

<p>
一个系统有多个功能，即有多个业务模块，表现在 struts.xml 中就是有多个 package。一个业务模块需要请求很多页面，相应一个 package 包含多个 action.
</p>

<p>
注意：必须要有模块化的概念，为业务创建相关的 package 和 namespace，这样便于管理维护，也便于功能的扩展。
</p>

<p>
定义 package 需要给予一个名字，还可以设置命名空间（默认为 / ）和父包。
</p>

<p>
我们自定义的 package 最好继承 struts-default 包，它定义在 struts-default.xml 中（可以展开 struts2-core.jar 看到）。这个 package 内置了一些 result 类型，一些拦截器，并配置了一些常见的 struts 常量。我们可以直接使用。
</p>

<p>
Package 主要由 action 构成，除此之外，还可以声明拦截器，配置包范围的异常处理，定义包范围的 result。
</p>
</div>
</section>

<section id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">Action</h2>
<div class="outline-text-2" id="text-6">
<p>
action 必须要有的属性是 name，这个定义了这个 action 的唯一标识。 class如果不指定的话，那么默认是 ActionSupport 类。 method 不指定的话，默认是 execute 方法。
</p>

<p>
action 至少要有一个节点，就是 result。如果 result 不去指定 name 的话，那么它的默认名字就是 success.
</p>

<p>
action 下面可以定义一到多个异常处理节点，用来捕获本次请求出现的指定异常。
</p>
<pre class="example">
&lt;exception-mapping result="fail" exception="java.lang.Exception"&gt;&lt;/exception-mapping&gt;
</pre>

<p>
如果请求的过程中，出现异常，那么 struts 首先判断当前 action 节点下面有没有配置相关的 exception-mapping 节点，如果有并且异常匹配，那么页面会转到本异常处理节点指定的页面。
</p>

<p>
如果 action 节点下面没有配置相关的 exception-mapping，那么 struts 会到当前包下面搜索，有没有配置 global-exception-mapping 节点。如果有配置，那么，就会根据所匹配的异常处理，进行返回结果。
</p>

<p>
如果 action 节点下面没有配置，而且包下面没有配置，那么，就不会有相应的异常处理。服务器会把一个 404 等相关的错误页面直接打印给用户。（这样首先不美观，不专业，其次，非常不安全。）
</p>

<p>
异常处理，可以在当前 action 节点下面配置。相应的，可以在 package 下面配置全局的异常处理。
</p>
<pre class="example">
&lt;global-exception-mappings&gt;
  &lt;exception-mapping result="fail" exception="java.lang.Exception"&gt;&lt;/exception-mapping&gt;
&lt;/global-exception-mappings&gt;
</pre>

<p>
返回结果，即 result，同样，我们需要在当前 action 下面配置。相应，可以在 package 下面配置全局的结果返回。
</p>
<pre class="example">
&lt;global-results&gt;
  &lt;result name="fail"&gt;/WEB-INF/login/login.jsp&lt;/result&gt;
&lt;/global-results&gt;
</pre>


<p>
Action 类的典型示例如下，很简单：
</p>

<div class="org-src-container">

<pre class="src src-java"><span style="color: #0000FF;">public</span> <span style="color: #6434A3;">Class</span> <span style="color: #006699;">LoginAction</span> <span style="color: #707183;">()</span> <span style="color: #707183;">{</span>
    <span style="color: #0000FF;">private</span> <span style="color: #6434A3;">String</span> <span style="color: #BA36A5;">name</span>;
    <span style="color: #0000FF;">private</span> <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">age</span>;

    <span style="color: #0000FF;">public</span> <span style="color: #6434A3;">String</span> <span style="color: #BA36A5;">execute</span> <span style="color: #7388D6;">()</span> <span style="color: #7388D6;">{</span>
        System.out.println<span style="color: #909183;">(</span><span style="color: #008000;">"&#21517;&#23383;&#26159;:"</span> + name + <span style="color: #008000;">"    &#24180;&#40836;&#20026;:"</span> + age<span style="color: #909183;">)</span>;
        <span style="color: #0000FF;">return</span> <span style="color: #008000;">"success"</span>;
    <span style="color: #7388D6;">}</span>

    <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">setter...</span>
    <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">setter...</span>
<span style="color: #707183;">}</span>
</pre>
</div>
</div>
</section>


<section id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7">Result</h2>
<div class="outline-text-2" id="text-7">
<p>
如果不指定名字，那么默认的名字就是 success, 如果不指定 type，默认的 type 就是 dispatcher。我们常用的就是一下几个。
</p>
</div>
<div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1">dispatcher/redirect</h3>
<div class="outline-text-3" id="text-7-1">
<p>
转发或者重定向，一般用于 jsp
</p>
<div class="org-src-container">

<pre class="src src-xml">&lt;<span style="color: #000088; background-color: #DEDEDE;">result</span> <span style="color: #BA36A5;">type</span>=<span style="color: #008000;">"</span><span style="color: #008000;">redirect</span><span style="color: #008000;">"</span> <span style="color: #BA36A5;">name</span>=<span style="color: #008000;">"</span><span style="color: #008000;">fail</span><span style="color: #008000;">"</span>&gt;/WEB-INF/jsp/login/fail.jsp&lt;/<span style="color: #000088; background-color: #DEDEDE;">result</span>&gt;
</pre>
</div>

<p>
如果 result 不指定类型的话，那么默认为 dispatcher.
</p>
</div>
</div>

<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2">chain/redirectAction</h3>
<div class="outline-text-3" id="text-7-2">
<p>
转发或者重定向 xxx.action，用于一个新的 struts 请求。
</p>

<p>
如果要转发到另外一个包下的连接的话：
</p>
<div class="org-src-container">

<pre class="src src-xml">&lt;<span style="color: #000088; background-color: #DEDEDE;">result</span> <span style="color: #BA36A5;">name</span>=<span style="color: #008000;">"</span><span style="color: #008000;">success</span><span style="color: #008000;">"</span> <span style="color: #BA36A5;">type</span>=<span style="color: #008000;">"</span><span style="color: #008000;">chain</span><span style="color: #008000;">"</span>&gt;
  &lt;<span style="color: #000088; background-color: #DEDEDE;">param</span> <span style="color: #BA36A5;">name</span>=<span style="color: #008000;">"</span><span style="color: #008000;">namespace</span><span style="color: #008000;">"</span>&gt;/emp&lt;/<span style="color: #000088; background-color: #DEDEDE;">param</span>&gt;
  &lt;<span style="color: #000088; background-color: #DEDEDE;">param</span> <span style="color: #BA36A5;">name</span>=<span style="color: #008000;">"</span><span style="color: #008000;">actionName</span><span style="color: #008000;">"</span>&gt;listAll&lt;/<span style="color: #000088; background-color: #DEDEDE;">param</span>&gt;
&lt;/<span style="color: #000088; background-color: #DEDEDE;">result</span>&gt;
</pre>
</div>

<p>
如果要重定向到另外一个包下面的请求的话，有下面两种写法：
</p>
<div class="org-src-container">

<pre class="src src-xml"><span style="color: #8D8D84;">&lt;!--</span><span style="color: #8D8D84; font-style: italic;"> &#19979;&#38754;&#20004;&#31181;&#20889;&#27861;&#26159;&#31561;&#25928;&#30340; </span><span style="color: #8D8D84;">--&gt;</span>
&lt;<span style="color: #000088; background-color: #DEDEDE;">result</span> <span style="color: #BA36A5;">type</span>=<span style="color: #008000;">"</span><span style="color: #008000;">redirectAction</span><span style="color: #008000;">"</span>&gt;
  &lt;<span style="color: #000088; background-color: #DEDEDE;">param</span> <span style="color: #BA36A5;">name</span>=<span style="color: #008000;">"</span><span style="color: #008000;">namespace</span><span style="color: #008000;">"</span>&gt;/emp&lt;/<span style="color: #000088; background-color: #DEDEDE;">param</span>&gt;
  &lt;<span style="color: #000088; background-color: #DEDEDE;">param</span> <span style="color: #BA36A5;">name</span>=<span style="color: #008000;">"</span><span style="color: #008000;">actionName</span><span style="color: #008000;">"</span>&gt;listAll&lt;/<span style="color: #000088; background-color: #DEDEDE;">param</span>&gt;
&lt;/<span style="color: #000088; background-color: #DEDEDE;">result</span>&gt;

&lt;<span style="color: #000088; background-color: #DEDEDE;">result</span> <span style="color: #BA36A5;">type</span>=<span style="color: #008000;">"</span><span style="color: #008000;">redirect</span><span style="color: #008000;">"</span>&gt;/emp/listAll.html&lt;/<span style="color: #000088; background-color: #DEDEDE;">result</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7-3" class="outline-3">
<h3 id="sec-7-3">stream</h3>
<div class="outline-text-3" id="text-7-3">
<p>
是用来处理 struts 中文件的上传和下载的。
</p>
</div>
</div>
</section>








<section id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8">流程</h2>
<div class="outline-text-2" id="text-8">
<ol class="org-ol">
<li>请求发送给 StrutsPrepareAndExecuteFilter
</li>
<li>StrutsPrepareAndExecuteFilter 询问 ActionMapper：请求是不是一个 Action(是的话返回非空的 ActionMapping)
</li>
<li>如果请求是一个 Action，则把请求交给 ActionProxy 对象处理。
</li>
<li>ActionProxy 中，通过 ConfigurationManager 加载配置文件，得到处理请求的 Action 类和方法。
</li>
<li>ActionProxy 创建一个 ActionInvocation 实例并初始化。
</li>
<li>ActionInvocation 负责调用 Action，在调用的前后，需要执行 Interceptor 链。在调用完 Action 后要执行 result 的结果。
</li>
<li>把结果发送到客户端。
</li>
</ol>
</div>
</section>

<section id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9">拦截器</h2>
<div class="outline-text-2" id="text-9">
<p>
所有实现了 Interceptor 接口的类，都叫拦截器。
在 Struts 中，是利用拦截器进行功能实现的，比如值的自动封装，类型的转换，值栈的维护，验证，国际化等方面。
每一个拦截器都实现用来完成单一的功能。多个拦截器，按照顺序放在一个列表中，按照顺序执行，可以达到完成一系列功能的目的。
这多个的拦截器放在一起，又称为拦截器栈（栈是一种非常基本的数据结构，它遵守先进后出的原则。简单理解，它是有顺序的一个列表）。
</p>

<p>
比如，在 struts 中，对值进行自动封装的拦截器叫 ParameterFilterInterceptor；对异常处理的拦截器叫 ExceptionMappingInterceptor，其他所有功能，在 struts 中都有相应的拦截器实现。
</p>

<p>
所以，在一个请求发起，经 struts 进行处理，程序流程在到达 action 相关的处理方法之前，会按照配置经过多个拦截器，从而实现一定的功能，比如，值的封装:
</p>
<pre class="example">
拦截器a -&gt; 拦截器 B -&gt; 拦截器 C -&gt; 拦截器 D ... -&gt; Action.Method -&gt; 后续的一些处理，包括返回显示页面等。
</pre>

<p>
在 struts.xml 中，需要为每个 action 设置拦截器，用来实现完整功能。
当然，如果我们不对 action 设置 interceptor-ref 节点，即不设置拦截器，那么如果我们的包继承了 struts-default，那么任何一个包内的 action，会默认使用 defaultStack 拦截器。它其实是一个拦截器栈，即是一系列的拦截器的一个列表。
</p>
</div>

<div id="outline-container-sec-9-1" class="outline-3">
<h3 id="sec-9-1">原理</h3>
</div>
<div id="outline-container-sec-9-2" class="outline-3">
<h3 id="sec-9-2">定义</h3>
</div>
<div id="outline-container-sec-9-3" class="outline-3">
<h3 id="sec-9-3">示例</h3>
</div>
</section>
<section id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10">自动封装(Autowired)</h2>
</section>
<section id="outline-container-sec-11" class="outline-2">
<h2 id="sec-11">值栈</h2>
<div class="outline-text-2" id="text-11">
<p>
EL(Expression Language) 是为了分离页面跟代码，避免JSP中糅杂太多&lt;% %&gt;而出现的。<br >
</p>

<p>
它有如下好处：
</p>
<ul class="org-ul">
<li>避免复杂的java代码，使页面简单整洁
</li>
<li>支持运算符，自由强大高效
</li>
<li>有简单的逻辑控制，易于阅读和维护
</li>
</ul>

<p>
Struts2 支持的 EL 语言有：
</p>
<ol class="org-ol">
<li>OGNL (Object-Graph Navigation Language) // Struts 默认
</li>
<li>JSTL (JSP Standard Tag Library)                 // JSP2.0集成
</li>
<li>Groovy
</li>
<li>Velocity，只是一个简单的模板匹配引擎啦
</li>
</ol>

<p>
Expression, Root, Context. getValue. setValue.
</p>


<p>
值栈是 struts 进行数据传递的中心，它是 struts 运行过程中创建的一个对象。本质上它是保存在 request 对象上的一个 attribute.
</p>

<p>
在 Struts 中，值栈（ValueStack）分为两个逻辑部分
</p>
<ol class="org-ol">
<li>对象栈

<p>
它其实是 Map 栈中的一个值。是作为一个默认的存在。本质上它是一个 ArrayList， Struts 在接受到一个请求的时候，会把创建的 Action 对象保存到这个 ArrayList 中。
</p>
</li>

<li>Map栈

<p>
本质上就是一个 Map，它是对 ActionContent 的引用。Struts 把一些常用的映射关系（比如，session,application,parameters等）保存到了这个对象中。
</p>

<p>
Map 栈的大致结构如下:
</p>
</li>
</ol>


<p>
在 jsp 页面中，如果打开了 devMove 模式，那么可以通过 &lt;s:debug /&gt; 查看整个值栈中保存的数据。
</p>
</div>


<div id="outline-container-sec-11-1" class="outline-3">
<h3 id="sec-11-1">在 jsp 中获取值栈的值</h3>
<div class="outline-text-3" id="text-11-1">
<p>
首先，可以使用 &lt;s:property /&gt; 标签，通过在 value 属性里面的 ognl 表达式，就可以取到值栈中对应的值了。
</p>

<p>
ognl 表达式的语法规则为：
</p>
<pre class="example">
#key.a.b.c
</pre>

<p>
当然，如果我们要获取的值，是属于 OgnlContext 的 Root 对象，那么，前面的 #key 可以去掉。
</p>

<p>
因此，如果我们在 Action 里面定义了变量（比如，price），并赋予了值，那么，到 jsp 页面中，我们就可以直接用下面语句取出它的值：
</p>
<pre class="example">
&lt;s:property value="price" /&gt;
</pre>

<p>
如果，我们要显示的值，是一个集合，比如，list，那么我们可以用 &lt;s:iterator /&gt; 标签循环取出它里面的值。
</p>
<div class="org-src-container">

<pre class="src src-java">&lt;s:iterator var=<span style="color: #008000;">"j"</span> value=<span style="color: #008000;">"emps"</span>&gt;
  &lt;tr&gt;
    &lt;td&gt;$<span style="color: #707183;">{</span>name<span style="color: #707183;">}</span>&lt;/td&gt;
    &lt;td&gt;&lt;s:property value=<span style="color: #008000;">"job"</span>/&gt;&lt;/td&gt;
    &lt;td&gt;&lt;s:property value=<span style="color: #008000;">"#j.sal"</span>/&gt;&lt;/td&gt;
    &lt;td&gt;&lt;a href=<span style="color: #008000;">"delete.html?ename=${name}"</span>&gt;<span style="color: #6434A3;">&#21024;&#38500;</span><span style="color: #707183;">&lt;</span>/a<span style="color: #707183;">&gt;</span>&lt;/td&gt;
  &lt;/tr&gt;
&lt;/s:iterator&gt;
</pre>
</div>


<p>
注意，因为 struts 中对 request 对象进行了封装，并且重载了它的 getAttribute 方法，使得可以通过 getAttribute 方法直接从值栈对象中获取值。
所以，如果我们在 jsp 页面中，使用el表达式，可以达到跟使用 &lt;s:property /&gt; 标签同样的效果。
</p>
</div>
</div>


<div id="outline-container-sec-11-2" class="outline-3">
<h3 id="sec-11-2">在 action 类中，获取 session 等对象的方法</h3>
<div class="outline-text-3" id="text-11-2">
<p>
在 action 中，向 session 中加入值，有如下几张方法：
</p>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#31532;&#19968;&#31181;&#65292;&#20174; ServletActionContext&#25552;&#20379;&#30340;&#38745;&#24577;&#26041;&#27861;&#33719;&#21462;&#12290;</span>
<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#27604;&#22914;&#65292;ServletActionContext.getRequest() &#24471;&#21040;&#30340;&#26159;&#19968;&#20010;&#21407;&#29983;&#30340; HttpServletRequest &#23545;&#35937;&#12290;&#24471;&#21040;&#21518;&#25105;&#20204;&#21487;&#20197;&#25353;&#29031;&#20197;&#21069;&#20889; servlet &#26102;&#20505;&#30340;&#20889;&#27861;&#22788;&#29702;&#36825;&#20010;&#23545;&#35937;&#12290;</span>
<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#25152;&#20197;&#65292;&#22914;&#26524;&#24819;&#24471;&#21040;&#22238;&#35805;&#23545;&#35937;&#30340;&#35805;&#65292;&#37027;&#20040;&#22914;&#19979;&#20195;&#30721;&#65306;</span>
<span style="color: #6434A3;">HttpSession</span> <span style="color: #BA36A5;">s1</span> = ServletActionContext.getRequest<span style="color: #707183;">()</span>.getSession<span style="color: #707183;">()</span>;
s1.setAttribute<span style="color: #707183;">(</span><span style="color: #008000;">"flag1"</span>, <span style="color: #008000;">"red"</span><span style="color: #707183;">)</span>;

<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">struts &#25552;&#20379;&#20102;&#21478;&#22806;&#19968;&#31181;&#23553;&#35013;&#65292;&#21363;&#25226; session,request &#31561;&#24403;&#20570; Map &#23545;&#35937;&#26469;&#22788;&#29702;&#65292;&#36798;&#21040;&#31616;&#21270;&#25105;&#20204;&#25805;&#20316;&#30340;&#30446;&#30340;&#12290;</span>
<span style="color: #6434A3;">Map</span><span style="color: #707183;">&lt;</span><span style="color: #6434A3;">String</span>, <span style="color: #6434A3;">Object</span><span style="color: #707183;">&gt;</span> <span style="color: #BA36A5;">s2</span> = ActionContext.getContext<span style="color: #707183;">()</span>.getSession<span style="color: #707183;">()</span>;
s2.put<span style="color: #707183;">(</span><span style="color: #008000;">"flag2"</span>, <span style="color: #008000;">"green"</span><span style="color: #707183;">)</span>;

<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#36890;&#36807;&#23454;&#29616; SessionAware &#25509;&#21475;&#65292;&#23450;&#20041;&#20840;&#23616;&#30340; session &#23545;&#35937;&#12290;</span>
<span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">&#39318;&#20808;&#35201;&#23450;&#20041;&#20840;&#23616;&#30340; Map&lt;String, Object&gt; s3 = null; &#28982;&#21518;&#23454;&#29616; SessionAware &#25509;&#21475;&#12290;</span>
s3.put<span style="color: #707183;">(</span><span style="color: #008000;">"flag3"</span>, <span style="color: #008000;">"yellow"</span><span style="color: #707183;">)</span>;
</pre>
</div>

<p>
在 jsp 页面中，这样使用session中的值。
</p>
<pre class="example">
&lt;s:property value="#session.flag" /&gt;
</pre>
</div>
</div>
</section>





<section id="outline-container-sec-12" class="outline-2">
<h2 id="sec-12">标签库</h2>
</section>
<section id="outline-container-sec-13" class="outline-2">
<h2 id="sec-13">验证</h2>
<div class="outline-text-2" id="text-13">
<p>
调用的 xwork 中的验证配置
</p>
<ol class="org-ol">
<li>声明式验证
<pre class="example">
ActionName[-Alias]-validation.xml
</pre>
</li>
<li>编程式验证
<pre class="example">
@Override public void validate () {}
</pre>
</li>
</ol>
</div>
</section>



<section id="outline-container-sec-14" class="outline-2">
<h2 id="sec-14">类型转换</h2>
<div class="outline-text-2" id="text-14">
<p>
struts 会自动进行类型转换。但一些复杂的对象，自动转换会满足不了我们的需求，这时候需要自定义类型转换器
</p>
<ol class="org-ol">
<li>创建转换器。必须要实现 ognl.TypeConverter 接口。实际上继承 StrutsTypeConverter 即可。
</li>
<li>基于字段，model/ModelClassName-conversion.properties。基于类型，src/xwork-conversion.properties
<pre class="example">
java.util.Date=你定义的类型转换器
</pre>
</li>
</ol>
</div>
</section>


<section id="outline-container-sec-15" class="outline-2">
<h2 id="sec-15">国际化</h2>
</section>
<section id="outline-container-sec-16" class="outline-2">
<h2 id="sec-16">文件的上传下载</h2>
</section>
<section id="outline-container-sec-17" class="outline-2">
<h2 id="sec-17">防止重复提交</h2>
<div class="outline-text-2" id="text-17">
<p>
三种情况：
</p>
<ol class="org-ol">
<li>多次点击
</li>
<li>回退，再提交
</li>
<li>转发时 F5 刷新
</li>
</ol>

<p>
解决方案： token 拦截器/ tokenSession 拦截器
</p>
<ol class="org-ol">
<li>在配置文件中添加 token 拦截器，它不包含在默认拦截器栈中。
</li>
<li>添加标签 &lt;s:token /&gt;，会在页面生成一个隐藏域并在session赋值，两个一致。
</li>
<li>若使用 token 拦截器，需要配置一个 token.valid 的 result，因为它要跳往错误页面
</li>
<li>tokenSession 则不用配置 result。页面不会动。tokenSession 拦截器不会执行后续拦截器。
</li>
</ol>
</div>
</section>

<section id="outline-container-sec-18" class="outline-2">
<h2 id="sec-18">ajax</h2>
</section>
</div>
<div id="postamble" class="status">
<p class="author">Author: imfine</p>
<p class="date">Created: 2016-10-18 周二 07:35</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.5.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation">Go ahead, never stop.</p>
</div>
</body>
</html>
